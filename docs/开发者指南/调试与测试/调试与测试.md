# 调试与测试

<cite>
**本文档引用文件**  
- [sys_user.go](file://server/api/v1/system/sys_user.go)
- [sys_user_service.go](file://server/service/system/sys_user.go)
- [sys_user_model.go](file://server/model/system/sys_user.go)
- [zap.go](file://server/config/zap.go)
- [main.go](file://server/main.go)
- [casbin_rbac.go](file://server/middleware/casbin_rbac.go)
- [logger.go](file://server/middleware/logger.go)
- [user.js](file://web/src/api/user.js)
- [request.js](file://web/src/utils/request.js)
- [validator.go](file://server/utils/validator.go)
</cite>

## 目录
1. [后端调试实践](#后端调试实践)
2. [前端调试实践](#前端调试实践)
3. [单元测试编写方法](#单元测试编写方法)
4. [API 模拟测试策略](#api-模拟测试策略)

## 后端调试实践

### 使用 Delve 调试 Gin 接口

Delve 是 Go 语言的调试器，可用于在开发过程中对 Gin Web 框架接口进行断点调试。通过集成 Delve 到 IDE（如 Goland 或 VS Code），开发者可以在 `server/api/v1/system/sys_user.go` 中设置断点，逐步执行用户管理相关接口逻辑，观察变量状态和函数调用栈。

启动调试模式前需确保项目已正确配置 `dlv` 命令行工具，并使用以下命令运行服务：

```bash
dlv debug --headless --listen=:2345 --api-version=2 server/main.go
```

该命令将启动 Delve 的远程调试服务，允许 IDE 连接并控制程序执行流程。

**章节来源**
- [main.go](file://server/main.go#L1-L20)
- [sys_user.go](file://server/api/v1/system/sys_user.go#L1-L50)

### 利用 Zap 日志进行追踪

本项目采用 Zap 作为高性能日志库，在 `server/config/zap.go` 中完成初始化配置。Zap 提供结构化日志输出，支持不同级别（Debug、Info、Error）的日志记录，便于问题排查。

例如，在用户登录失败时，系统会通过 Zap 记录详细上下文信息：

```go
global.GVA_LOG.Error("用户登录失败", zap.String("username", username), zap.Error(err))
```

这些日志可被集中收集至 ELK 或 Loki 等平台，实现跨请求链路追踪。

建议开启开发环境下的 `consoleEncoder` 和 `levelEnabler` 配置以增强可读性。

**章节来源**
- [zap.go](file://server/config/zap.go#L10-L60)
- [logger.go](file://server/middleware/logger.go#L15-L40)

### 通过 Postman 测试 API

Postman 可用于手动测试所有 Gin 暴露的 RESTful 接口。针对 `/api/v1/user` 相关路由，可通过构造如下请求验证功能：

- **GET /api/v1/user/list**：获取用户列表，需携带 JWT Token
- **POST /api/v1/user/create**：创建新用户，提交 JSON 数据体
- **PUT /api/v1/user/update**：更新用户信息
- **DELETE /api/v1/user/delete**：软删除用户

建议在 Postman 中建立“用户管理”集合，保存常用请求模板，并利用环境变量管理不同部署环境（本地、测试、生产）的 base URL 和 token。

**章节来源**
- [sys_user.go](file://server/api/v1/system/sys_user.go#L50-L100)
- [jwt.go](file://server/middleware/jwt.go#L20-L50)

## 前端调试实践

### Vue Devtools 使用

Vue Devtools 是 Chrome 浏览器扩展，专为 Vue 应用提供组件树查看、状态监控、事件追踪等功能。在本项目中，可通过 Devtools 查看 `web/src/view/superAdmin/user/user.vue` 组件实例的 props、data、computed 属性及 Vuex store 状态。

特别地，Pinia 模块（位于 `web/src/pinia/modules/user.js`）的状态变更可在 Devtools 的 "State" 面板中实时观察，有助于定位数据同步问题。

安装后，在浏览器开发者工具中选择 “Vue” 标签页即可开始调试。

**章节来源**
- [user.vue](file://web/src/view/superAdmin/user/user.vue#L1-L30)
- [user.js](file://web/src/pinia/modules/user.js#L10-L50)

### Vite 热重载调试

Vite 提供极速热模块替换（HMR），修改 `web/src/api/user.js` 或任何 `.vue` 文件后，页面将自动刷新并保留当前应用状态。这对于调试表单交互或权限控制非常有用。

若热重载未生效，请检查：
- `vite.config.js` 是否正确配置了 `server.hmr`
- 浏览器控制台是否有模块解析错误
- 是否存在语法错误导致编译中断

此外，可通过 `console.log` 输出中间值，结合浏览器断点进行逻辑验证。

**章节来源**
- [vite.config.js](file://web/vite.config.js#L10-L30)
- [user.js](file://web/src/api/user.js#L1-L25)

### 网络请求拦截分析

利用浏览器开发者工具的 "Network" 面板，可捕获所有由 `web/src/utils/request.js` 发出的 Axios 请求。重点关注：
- 请求头中的 `Authorization` 字段是否携带有效 token
- POST 请求体是否符合后端预期格式
- 错误响应（4xx/5xx）的具体原因

还可结合 `request.interceptors.request` 和 `response` 拦截器添加自定义日志输出，辅助定位问题。

**章节来源**
- [request.js](file://web/src/utils/request.js#L20-L80)
- [user.js](file://web/src/api/user.js#L30-L60)

## 单元测试编写方法

### sys_user 服务单元测试示例

以 `server/service/system/sys_user.go` 为例，Go 单元测试应遵循标准命名规范：`*_test.go`。测试文件应位于同一包下，通常命名为 `sys_user_test.go`。

关键测试场景包括：
- 创建用户时用户名唯一性校验
- 更新用户信息时权限检查（RBAC）
- 删除用户时级联关系处理
- 分页查询性能边界测试

使用 testify/assert 断言库提升可读性：

```go
func TestCreateUser(t *testing.T) {
	service := &SysUserService{}
	user := &model.SysUser{Username: "testuser"}
	err := service.CreateUser(user)
	assert.NoError(t, err)
}
```

运行测试套件命令：

```bash
go test -v ./server/service/system/...
```

建议覆盖核心业务逻辑的关键路径，并定期生成覆盖率报告：

```bash
go test -coverprofile=coverage.out ./server/service/system/
go tool cover -html=coverage.out
```

**章节来源**
- [sys_user_service.go](file://server/service/system/sys_user.go#L1-L40)
- [sys_user_model.go](file://server/model/system/sys_user.go#L1-L50)
- [validator.go](file://server/utils/validator.go#L15-L60)

## API 模拟测试策略

### 前端 API 客户端模拟

为避免依赖后端服务稳定性，前端可使用 Mock 方案隔离测试。推荐使用 `vite-plugin-mock-dev-server` 插件，在 `vite.config.js` 中启用 mock 支持。

在 `web/src/api/user.js` 对应目录下创建 mock 文件：

```js
// mock/user.js
export default [
  {
    url: '/api/v1/user/list',
    method: 'get',
    response: () => ({
      code: 200,
      data: { list: [{ id: 1, userName: 'admin' }], total: 1 }
    })
  }
]
```

此方式可在无后端服务时完整测试 UI 渲染、分页、搜索等交互逻辑。

对于更复杂的场景，也可使用 MSW（Mock Service Worker）实现网络层拦截。

**章节来源**
- [user.js](file://web/src/api/user.js#L1-L20)
- [vite.config.js](file://web/vite.config.js#L40-L60)