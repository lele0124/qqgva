
# 部署与运维

<cite>
**本文档引用文件**  
- [Dockerfile](file://deploy/docker/Dockerfile)
- [entrypoint.sh](file://deploy/docker/entrypoint.sh)
- [docker-compose.yaml](file://deploy/docker-compose/docker-compose.yaml)
- [gva-server-configmap.yaml](file://deploy/kubernetes/server/gva-server-configmap.yaml)
- [gva-server-deployment.yaml](file://deploy/kubernetes/server/gva-server-deployment.yaml)
- [gva-server-service.yaml](file://deploy/kubernetes/server/gva-server-service.yaml)
- [gva-web-configmap.yaml](file://deploy/kubernetes/web/gva-web-configmap.yaml)
- [gva-web-deploymemt.yaml](file://deploy/kubernetes/web/gva-web-deploymemt.yaml)
- [gva-web-ingress.yaml](file://deploy/kubernetes/web/gva-web-ingress.yaml)
- [gva-web-service.yaml](file://deploy/kubernetes/web/gva-web-service.yaml)
- [config.docker.yaml](file://server/config.docker.yaml)
</cite>

## 目录
1. [简介](#简介)
2. [Docker镜像构建](#docker镜像构建)
3. [Docker Compose一体化部署](#docker-compose一体化部署)
4. [Kubernetes部署配置详解](#kubernetes部署配置详解)
5. [配置管理与环境变量注入](#配置管理与环境变量注入)
6. [持久化存储与网络策略](#持久化存储与网络策略)
7. [性能调优建议](#性能调优建议)
8. [监控与日志策略](#监控与日志策略)

## 简介
本指南详细说明如何在多种生产环境中部署 `gin-vue-admin` 项目。涵盖使用 Docker 构建前后端镜像、通过 docker-compose 进行本地或测试环境的一体化部署,以及针对 Kubernetes 环境的完整部署方案。同时讨论了配置管理、环境变量注入、持久化存储、网络策略、性能优化和监控建议。

## Docker镜像构建

### 后端与前端镜像构建流程
项目提供统一的 `Dockerfile` 用于构建包含后端服务和前端资源的整体镜像。该文件位于 `deploy/docker/Dockerfile`,基于 CentOS 7 基础镜像,集成 Nginx、MySQL、Redis 和 Go 运行环境。

构建过程包括:
- 设置工作目录并复制启动脚本 `entrypoint.sh`
- 复制已编译的后端二进制文件及前端静态资源到指定路径
- 安装必要的系统依赖和服务(Nginx、MySQL、Redis、Go、npm)
- 暴露 80 端口,并设置启动入口为 `entrypoint.sh`

此设计实现了单容器内运行多个服务的轻量级部署模式,适用于快速部署和开发测试场景。

**Section sources**
- [Dockerfile](file://deploy/docker/Dockerfile#L1-L18)
- [entrypoint.sh](file://deploy/docker/entrypoint.sh#L1-L19)

### 启动脚本逻辑分析
`entrypoint.sh` 脚本负责初始化数据库、启动 Redis,并根据运行模式启动服务。

关键逻辑如下:
- 若 MySQL 数据目录为空,则执行无密码初始化,创建 `gva` 数据库并授权 root 用户访问。
- 启动 MySQL 和 Redis 服务作为后台进程。
- 根据传入参数判断是否进入开发模式(`actions`),否则以生产模式启动 Nginx 和后端服务。

该脚本确保了容器首次启动时能自动完成数据库初始化,简化部署流程。

**Section sources**
- [entrypoint.sh](file://deploy/docker/entrypoint.sh#L1-L19)

## Docker Compose一体化部署

### 服务编排结构
`docker-compose.yaml` 文件定义了四个核心服务:`web`(前端)、`server`(后端)、`mysql` 和 `redis`,并通过自定义网络 `network` 实现容器间通信。

各服务特点:
- **web**: 基于 `web/Dockerfile` 构建,监听 8080 端口,依赖 `server` 服务。
- **server**: 基于 `server/Dockerfile` 构建,暴露 8888 端口,依赖健康状态下的 MySQL 和 Redis。
- **mysql**: 使用官方 MySQL 8.0.21 镜像,配置 UTF8MB4 字符集,映射宿主机 13306 端口,数据卷持久化。
- **redis**: 使用 Redis 6.0.6 镜像,开启健康检查,数据卷持久化。

所有服务通过固定 IP 地址分配(如 web: 177.7.0.11)增强网络稳定性。

**Section sources**
- [docker-compose.yaml](file://deploy/docker-compose/docker-compose.yaml#L1-L91)

### 健康检查机制
MySQL 和 Redis 均配置了健康检查探针:
- MySQL 使用 `mysqladmin ping` 命令验证连接。
- Redis 使用 `redis-cli ping` 检查响应。

后端服务 `server` 通过 `depends_on` 的 `condition: service_healthy` 确保仅在数据库和缓存服务健康后才启动,避免因依赖未就绪导致启动失败。

**Section sources**
- [docker-compose.yaml](file://deploy/docker-compose/docker-compose.yaml#L65-L75)

## Kubernetes部署配置详解

### Server组件部署配置
#### ConfigMap 配置映射
`gva-server-configmap.yaml` 将 `config.docker.yaml` 内容作为配置挂载至容器内部,实现配置与镜像解耦。配置项覆盖 JWT、Zap 日志、Redis、数据库、OSS 存储等多种模块。

特别注意 `mysql.addr` 应指向集群内服务名而非 IP,例如可设为 `gva-mysql.default.svc.cluster.local`。

**Section sources**
- [gva-server-configmap.yaml](file://deploy/kubernetes/server/gva-server-configmap.yaml#L1-L149)
- [config.docker.yaml](file://server/config.docker.yaml#L1-L283)

#### Deployment 部署定义
`gva-server-deployment.yaml` 定义了后端应用的部署策略:
- 使用阿里云镜像仓库镜像 `registry.cn-hangzhou.aliyuncs.com/gva/server:latest`
- 挂载 ConfigMap 至 `/go/src/github.com/flipped-aurora/gin-vue-admin/server/config.docker.yaml`
- 设置 CPU 和内存资源限制与请求
- 配置 TCP 探针进行存活(liveness)、就绪(readiness)和启动(startup)检查,确保服务稳定

**Section sources**
- [gva-server-deployment.yaml](file://deploy/kubernetes/server/gva-server-deployment.yaml#L1-L74)

#### Service 服务暴露
`gva-server-service.yaml` 创建 ClusterIP 类型的服务,将内部 8888 端口暴露给集群内其他服务调用。前端服务可通过 `http://gva-server:8888` 访问 API。

**Section sources**
- [gva-server-service.yaml](file://deploy/kubernetes/server/gva-server-service.yaml#L1-L22)

### Web组件部署配置
#### ConfigMap 配置
`gva-web-configmap.yaml` 提供 Nginx 的反向代理配置,实现:
- 静态资源服务(`location /`)
- API 请求代理至后端服务(`location /api`)
- Swagger 文档单独路由代理

支持跨域请求处理和缓存控制。

**Section sources**
- [gva-web-configmap.yaml](file://deploy/kubernetes/web/gva-web-configmap.yaml#L1-L32)

#### Ingress 路由规则
`gva-web-ingress.yaml` 定义外部访问入口,绑定域名 `demo.gin-vue-admin.com`,将根路径 `/` 流量转发至 `gva-web` 服务,实现外部用户访问前端界面。

**Section sources**
- [gva-web-ingress.yaml](file://deploy/kubernetes/web/gva-web-ingress.yaml#L1-L18)

#### Web Deployment 与 Service
`gva-web-deploymemt.yaml` 部署前端 Nginx 容器,挂载上述 ConfigMap；`gva-web-service.yaml` 创建 ClusterIP 服务暴露 8080 端口,供 Ingress 控制器调用。

**Section sources**
- [gva-web-deploymemt.yaml](file://deploy/kubernetes/web/gva-web-deploymemt.yaml#L1-L52)
- [gva-web-service.yaml](file://deploy/kubernetes/web/gva-web-service.yaml#L1-L22)

## 配置管理与环境变量注入

### 配置文件分离策略
项目采用 `config.docker.yaml` 作为生产环境配置模板,通过 ConfigMap 或直接挂载方式注入容器。建议结合 Helm 或 Kustomize 实现多环境差异化配置管理。

敏感信息(如数据库密码、密钥)应通过 Kubernetes Secret 注入,而非明文写入 ConfigMap。

###