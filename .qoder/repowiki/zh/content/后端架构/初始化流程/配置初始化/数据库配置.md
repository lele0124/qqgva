
# 数据库配置

<cite>
**本文档引用文件**
- [db_list.go](file://server/config/db_list.go)
- [gorm_mysql.go](file://server/config/gorm_mysql.go)
- [gorm_pgsql.go](file://server/config/gorm_pgsql.go)
- [gorm_mssql.go](file://server/config/gorm_mssql.go)
- [gorm_oracle.go](file://server/config/gorm_oracle.go)
- [gorm_sqlite.go](file://server/config/gorm_sqlite.go)
- [gorm.go](file://server/initialize/gorm.go)
- [gorm_mysql.go](file://server/initialize/gorm_mysql.go)
- [gorm_pgsql.go](file://server/initialize/gorm_pgsql.go)
- [gorm_mssql.go](file://server/initialize/gorm_mssql.go)
- [gorm_oracle.go](file://server/initialize/gorm_oracle.go)
- [gorm_sqlite.go](file://server/initialize/gorm_sqlite.go)
- [config.go](file://server/config/config.go)
</cite>

## 目录
1. [简介](#简介)
2. [数据库配置结构解析](#数据库配置结构解析)
3. [DBList 结构体与多数据库映射机制](#dblist-结构体与多数据库映射机制)
4. [不同数据库驱动的差异化配置字段](#不同数据库驱动的差异化配置字段)
5. [GORM 引擎初始化流程](#gorm-引擎初始化流程)
6. [自动表迁移机制](#自动表迁移机制)
7. [多数据库切换操作示例](#多数据库切换操作示例)
8. [常见问题排查指南](#常见问题排查指南)
9. [总结](#总结)

## 简介
本项目支持 MySQL、PostgreSQL、SQL Server、Oracle 和 SQLite 五种主流数据库,并通过 Viper 实现配置文件驱动的灵活数据库管理。系统在启动时根据 `config.yaml` 中的配置动态加载多个数据库实例,利用 GORM 进行 ORM 映射和连接池管理。核心机制包括:基于 `SpecializedDB` 的多数据库定义、按类型分发的驱动初始化逻辑、以及统一的表结构自动同步功能。

## 数据库配置结构解析

系统通过 `config.yaml` 文件中的 `db-list` 字段定义多个数据库连接信息。每个数据库条目包含通用配置(如用户名、密码、端口)和特定于类型的扩展属性。Viper 将 YAML 配置反序列化为 Go 结构体,实现运行时动态读取。

```mermaid
flowchart TD
A["读取 config.yaml"] --> B{解析 db-list 列表}
B --> C["提取每个数据库项"]
C --> D["映射到 SpecializedDB 结构"]
D --> E["调用对应驱动初始化函数"]
E --> F["建立 GORM DB 实例"]
F --> G["存入全局变量 GVA_DBList"]
```

**Diagram sources**
- [db_list.go](file://server/config/db_list.go#L0-L53)
- [config.go](file://server/config/config.go#L19-L19)

**Section sources**
- [db_list.go](file://server/config/db_list.go#L0-L53)
- [config.go](file://server/config/config.go#L19-L19)

## DBList 结构体与多数据库映射机制

`SpecializedDB` 结构体位于 `server/config/db_list.go`,是多数据库配置的核心数据模型。它嵌入了通用数据库配置 `GeneralDB`,并通过 `Type` 字段区分数据库类型(mysql、pgsql、mssql、oracle、sqlite),`AliasName` 提供别名访问标识。

该结构体通过 `mapstructure:"db-list"` 标签由 Viper 解析,形成 `[]SpecializedDB` 切片,供后续遍历初始化使用。

```go
type SpecializedDB struct {
	Type      string `mapstructure:"type" json:"type" yaml:"type"`
	AliasName string `mapstructure:"alias-name" json:"alias-name" yaml:"alias-name"`
	GeneralDB `yaml:",inline" mapstructure:",squash"`
	Disable   bool `mapstructure:"disable" json:"disable" yaml:"disable"`
}
```

在 `initialize.DBList()` 函数中,程序遍历 `global.GVA_CONFIG.DBList`,依据 `Type` 字段分发至不同的 GORM 初始化函数,最终将所有活动数据库实例存储于 `global.GVA_DBList` 映射中,键为 `AliasName`。

若存在别名为 `sys` 的数据库,则将其设为默认数据库 `global.GVA_DB`,用于主业务逻辑操作。

**Section sources**
- [db_list.go](file://server/config/db_list.go#L0-L53)
- [db_list.go](file://server/initialize/db_list.go#L10-L35)

## 不同数据库驱动的差异化配置字段

所有数据库共享 `GeneralDB` 中的通用配置字段:

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `prefix` | string | 表前缀 |
| `port` | string | 端口号 |
| `config` | string | 高级连接参数(如 charset, parseTime) |
| `db-name` | string | 数据库名称 |
| `username` | string | 用户名 |
| `password` | string | 密码 |
| `path` | string | 主机地址 |
| `engine` | string | 存储引擎(MySQL 特有) |
| `log-mode` | string | GORM 日志级别(silent/error/warn/info) |
| `max-idle-conns` | int | 最大空闲连接数 |
| `max-open-conns` | int | 最大打开连接数 |
| `singular` | bool | 是否禁用复数表名 |

各数据库通过实现 `Dsn()` 方法生成符合规范的连接字符串:

- **MySQL**: 使用 `tcp()` 包装地址,格式为 `user:pass@tcp(host:port)/dbname?param`
- **PostgreSQL**: 使用 `host=user password=pass dbname=name port=port` 格式
- **SQL Server**: 使用 `sqlserver://user:pass@host:port?database=name&encrypt=disable`
- **Oracle**: 使用 `oracle://user:pass@host:port/sid?param` 格式
- **SQLite**: 返回本地文件路径 `filepath.Join(path, dbname+".db")`

**Section sources**
- [gorm_mysql.go](file://server/config/gorm_mysql.go#L0-L9)
- [gorm_pgsql.go](file://server/config/gorm_pgsql.go#L0-L17)
- [gorm_mssql.go](file://server/config/gorm_mssql.go#L0-L10)
- [gorm_oracle.go](file://server/config/gorm_oracle.go#L0-L18)
- [gorm_sqlite.go](file://server/config/gorm_sqlite.go#L0-L13)

## GORM 引擎初始化流程

系统通过 `initialize.Gorm()` 函数根据当前激活的数据库类型(`global.GVA_CONFIG.System.DbType`)选择对应的初始化函数:

```mermaid
graph TD
Start([开始]) --> CheckType{检查 DbType}
CheckType --> |mysql| InitMysql[GormMysql]
CheckType --> |pgsql| InitPgsql[GormPgSql]
CheckType --> |mssql| InitMssql[GormMssql]
CheckType --> |oracle| InitOracle[GormOracle]
CheckType --> |sqlite| InitSqlite[GormSqlite]
CheckType --> |default| InitMysql
InitMysql --> SetActiveDB[设置 GVA_ACTIVE_DBNAME]
InitPgsql --> SetActiveDB
InitMssql --> SetActiveDB
InitOracle --> SetActiveDB
InitSqlite --> SetActiveDB
SetActiveDB --> ReturnDB[返回 *gorm.DB]
ReturnDB --> End([结束])
```

**Diagram sources**
- [gorm.go](file://server/initialize/gorm.go#L13-L34)

**Section sources**
- [gorm.go](file://server/initialize/gorm.go#L13-L34)

每个初始化函数内部调用私有辅助函数(如 `initMysqlDatabase`),完成以下步骤:
1. 检查数据库名是否为空
2. 构造对应驱动的配置对象(如 `mysql.Config`)
3. 调用 `gorm.Open()` 打开数据库连接
4. 设置连接池参数(最大空闲/打开连接数)
5. 对 MySQL 设置表引擎选项
6. 返回 GORM 数据库实例

## 自动表迁移机制

在 `initialize.RegisterTables()` 函数中,系统调用 `db.AutoMigrate()` 方法对预定义的系统模型和示例模型执行自动表结构同步。此过程确保数据库表结构与 Go 结构体定义保持一致。

主要迁移的表包括:
- 系统权限相关:`sys_user`, `sys_authority`, `sys_api`, `sys_menu`
- 操作记录:`sys_operation_record`
- 文件上传:`exa_file_upload_and_download`
- 自动代码生成历史:`sys_auto_code_history`

迁移过程在 `main.go` 的初始化流程中被调用,前提是 `global.GVA_DB` 不为 nil。

```mermaid
sequenceDiagram
participant Main as main.go
participant Init as initialize
participant Gorm as Gorm()
participant Register as RegisterTables()
Main->>Init : initializeSystem()
Init->>Gorm : Gorm()
Gorm-->>Init : 返回 *gorm.DB
Init->>Register : RegisterTables()
Register->>Gorm : db.AutoMigrate(models)
Gorm-->>Register : 完成表结构同步
Register-->>Init : 返回成功或错误
```

**Diagram sources**
- [gorm.go](file://server/initialize/gorm.go#L36-L79)
- [main.go](file://server/main.go#L38-L50)

**Section sources**
- [gorm.go](file://server/initialize/gorm.go#L36-L79)

## 多数据库切换操作示例

### 1. 配置文件设置(config.yaml)

```yaml
db-list:
  - type: mysql
    alias-name: primary_db
    host: 127.0.0.1
    port: "3306"
    username: root
    password: "123456"
    db-name: gva_db
    max-idle-conns: 10
    max-open-conns: 100
    log-mode: info
    config: "charset=utf